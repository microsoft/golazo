name: build-bundles
run-name: ${{ github.actor }} is bundling documents together
on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
jobs:
  Generating-Bound-Versions:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: ./tools/InstallUbuntuBuildDependencies.sh
      - run: ./tools/PreCheckinUpdate.sh
      - name: Upload bound_docs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bound_docs
          path: |
            ./docs/bound_docs/*.docx
            ./docs/bound_docs/*.epub
            ./docs/bound_docs/*.pdf

  Create-Release:
    needs: Generating-Bound-Versions
    runs-on: ubuntu-latest

    permissions:
      contents: write

    # Only create a release, on a push (not a PR), into main.  Push into mains are
    #    something only github can do, as users may only issue a PR (which,
    #    when completed, will issue the push). Also execute on tag pushes
    if: github.event_name == 'push' && (
      github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    )

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download bound_docs artifact
        uses: actions/download-artifact@v4
        with:
          name: bound_docs
          path: ./release-files

      - name: Generate release tag
        id: tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Documentation Bundle ${{ steps.tag.outputs.tag }}
          body: |
            Automated release of bundled documentation files.

            Generated from commit: ${{ github.sha }}

            This release contains:
            - DOCX files for offline reading
            - EPUB files for e-readers
            - PDF files for printing and sharing
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}

      - name: Upload all release files
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            ./release-files/*.docx
            ./release-files/*.epub
            ./release-files/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
